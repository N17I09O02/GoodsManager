@model List<Web_Manage.Models.DonHang>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Danh sách đơn hàng";
}

<h2>Danh sách đơn hàng của khách hàng</h2>

<script type="module">
    import { xemHinhAnhById, anNutNeuKhongCoAnh } from '/js/imageViewer.js';

    window.xemHinhLanDatHang = (id) => {
        xemHinhAnhById(id, '/api/ImageApi/get-url', `img-container-${id}`);
    };

    document.addEventListener("DOMContentLoaded", () => {
        const ids = @Html.Raw(Json.Serialize(Model.Select(x => x.IdDonHang)));

        for (let id of ids) {

            // Kiểm tra ảnh và ẩn nút nếu không có
            anNutNeuKhongCoAnh(id, '/api/ImageApi/get-url', `btn-xem-anh-${id}`);
        }
    });
</script>

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info">Khách hàng chưa có đơn hàng nào.</div>
}
else
{
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Mã đơn hàng</th>
                <th>Ngày đặt</th>
                <th>Tổng tiền</th>
                <th>Hình ảnh</th>
                <th>ThanhToan</th>
                <th>Chi tiết</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var dh in Model)
            {
                <tr>
                    <td>@dh.IdDonHang</td>
                    <td>@dh.NgayDat.ToString("dd/MM/yyyy")</td>
                    <td>@dh.TongTien.ToString("N0") đ</td>
                    <td>
                        <button id="btn-xem-anh-@dh.IdDonHang" onclick="xemHinhLanDatHang(@dh.IdDonHang)" class="btn btn-sm btn-info">Xem ảnh</button>
                        <div id="img-container-@dh.IdDonHang" class="mt-1"></div>
                        <form asp-controller="Image" asp-action="Create" method="post" enctype="multipart/form-data" class="d-flex flex-column">
                            <input type="hidden" name="idDonHang" value="@dh.IdDonHang" />
                            <input type="hidden" name="idLanDatHang" value="0" />

                            <!-- Chỉ chấp nhận ảnh JPG -->
                            <input type="file" name="file" accept=".jpg,image/jpeg" required class="form-control-file" />

                            <button type="submit" class="btn btn-success btn-sm mt-1">Tải ảnh</button>
                        </form>
                    </td>
                    <td>
                        <input type="checkbox"
                        @(dh.ThanhToan ? "checked" : "")
                               onchange="capNhatThanhToan(@dh.IdDonHang, this.checked)" />
                    </td>

                    <td>
                        <a asp-action="DetailLanDatHang" asp-route-id="@dh.IdDonHang" class="btn btn-info btn-sm">Xem chi tiết</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<script>
    async function capNhatThanhToan(idDonHang, daThanhToan) {
        try {
            const res = await fetch(`/api/DonHangApi/UpdateThanhToan/${idDonHang}/${daThanhToan}`, {
                method: 'PUT'
            });
            if (!res.ok) {
                alert("❌ Lỗi khi cập nhật trạng thái thanh toán!");
            } else {
                console.log(`✅ Đã cập nhật thanh toán đơn hàng ${idDonHang}: ${daThanhToan}`);
            }
        } catch (error) {
            alert("❌ Lỗi mạng khi gửi yêu cầu!");
        }
    }
</script>
